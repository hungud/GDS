CREATE OR REPLACE PACKAGE PKG_GDS_MODULO_COMISION_PTA IS

  -- Author  : BCHOY
  -- Created : 03/10/2017 15:32:11
  -- Purpose : 
  
  -- Public type declarations
  type cursorGDS IS REF CURSOR;
  
PROCEDURE GDS_LIMPIAR_CONCEPTOS(
  p_PNR           IN varchar2,
  p_Transportador IN varchar2,
  p_RowsAffected  OUT number);  

PROCEDURE GDS_LIMPIAR_EVALUACIONES(
  p_PNR           IN varchar2,
  p_Transportador IN varchar2,
  p_RowsAffected  OUT number);  

PROCEDURE GDS_OBTENER_CONCEPTOS(
  p_PNR           IN varchar2,
  p_Transportador IN varchar2,
  p_Cursor        OUT cursorGDS);

PROCEDURE GDS_OBTENER_ADICIONAL(
  p_IdCliente     IN number,
  p_PNR           IN varchar2,
  p_Transportador IN varchar2,
  p_Cursor        OUT cursorGDS);

PROCEDURE GDS_OBTENER_COMISION_X_DEFECTO(
  p_Transportador  IN varchar2,
  p_IdEmpresa      IN number,
  p_IdGrupo        IN number,
  p_Comision       OUT number);

END PKG_GDS_MODULO_COMISION_PTA;

-- // --

CREATE OR REPLACE PACKAGE BODY PKG_GDS_MODULO_COMISION_PTA IS

PROCEDURE GDS_LIMPIAR_CONCEPTOS (
  p_PNR           IN varchar2,
  p_Transportador IN varchar2,
  p_RowsAffected  OUT number)

AS
BEGIN 
  DELETE FROM TOURCODES_CONCEPTOSXTRANS 
  WHERE (UPPER(CODIGO_RESERVA) = UPPER(p_PNR))
  AND (UPPER(ID_TRANSPORTADOR) = UPPER(p_Transportador));

  p_RowsAffected := SQL%ROWCOUNT;  

END GDS_LIMPIAR_CONCEPTOS;

PROCEDURE GDS_LIMPIAR_EVALUACIONES(
  p_PNR           IN varchar2,
  p_Transportador IN varchar2,
  p_RowsAffected  OUT number)

AS
BEGIN 
  DELETE FROM TOURCODES_EVALUACION 
  WHERE (UPPER(CODIGO_RESERVA) = UPPER(p_PNR))
  AND (UPPER(ID_TRANSPORTADOR) = UPPER(p_Transportador));

  p_RowsAffected := SQL%ROWCOUNT;  

END GDS_LIMPIAR_EVALUACIONES;

PROCEDURE GDS_OBTENER_CONCEPTOS(
  p_PNR           IN varchar2,
  p_Transportador IN varchar2,
  p_Cursor        OUT cursorGDS)

AS
BEGIN 
  OPEN p_Cursor FOR 
  SELECT 
    CT.CODIGO_CONCEPTO AS IDCONCEPTO,
    CO.DESCRIPCION_CONCEPTO AS CONCEPTO, 
    TC.CODIGO_TIPO_DATO_CONCEPTO AS IDTIPOCONCEPTO,
    TC.DESCRIPCION_TIPO_DATO_CONCEPTO AS TIPOCONCEPTO,
    TC.USAR_COMILLAS AS ENTRECOMILLAS
  FROM TOURCODES_CONCEPTOSXTRANS CT
  INNER JOIN TOURCODES_CONCEPTOS CO ON (CT.CODIGO_CONCEPTO = CO.CODIGO_CONCEPTO) 
  INNER JOIN TOURCODES_TIPOSDATOSCONCEPTO TC ON (CO.CODIGO_TIPO_DATO_CONCEPTO = TC.CODIGO_TIPO_DATO_CONCEPTO)
  WHERE (CO.EN_DESUSO = 0)
  AND (CT.CODIGO_RESERVA = UPPER(p_PNR))
  AND (CT.ID_TRANSPORTADOR = UPPER(p_Transportador))
  ORDER BY CT.CODIGO_CONCEPTO ASC;

END GDS_OBTENER_CONCEPTOS;

PROCEDURE GDS_OBTENER_ADICIONAL(
  p_IdCliente     IN number,
  p_PNR           IN varchar2,
  p_Transportador IN varchar2,
  p_Cursor        OUT cursorGDS)

AS
BEGIN 
  OPEN p_Cursor FOR 
  SELECT 
    DE.DSCTO_EXTRA AS DESCUENTOEXTRA,
    DE.PROMOTOR_ID AS IDPROMOTOR, 
    PM.NOMBRE AS NOMBREPROMOTOR, 
    DE.VENDEDOR_ID AS IDVENDEDOR, 
    VD.NOMBRE AS NOMBREVENDEDOR   
  FROM WEB_AUTORIZACION_DSCTO_EXTRA DE 
  LEFT JOIN PROMOTOR PM ON (DE.PROMOTOR_ID = PM.ID_PROMOTOR)
  LEFT JOIN VENDEDOR VD ON (DE.VENDEDOR_ID = VD.ID_VENDEDOR)
  WHERE (DE.CLIENTE_ID = p_IdCliente)
  AND (DE.COD_RESERVA = UPPER(p_PNR))
  AND (DE.LINEAAEREA_IATA = UPPER(p_Transportador))
  AND (TO_CHAR(DE.AUTHDSCTO_FECHA,'DD/MM/YYYY') = TO_CHAR(CURRENT_DATE,'DD/MM/YYYY'));

END GDS_OBTENER_ADICIONAL;

PROCEDURE GDS_OBTENER_COMISION_X_DEFECTO(
  p_Transportador  IN varchar2,
  p_IdEmpresa      IN number,
  p_IdGrupo        IN number,
  p_Comision       OUT number)

AS
BEGIN 
  p_Comision := 0;

  SELECT 
    TCOM.PORC_COMISION_LINEA_AEREA INTO p_Comision
  FROM TOURCODES_COMISIONES TCOM
  INNER JOIN TOURCODES_TARIFARIO TT 
  ON TCOM.ID_TRANSPORTADOR = TT.ID_TRANSPORTADOR
  AND TCOM.ID_EMPRESA = TT.ID_EMPRESA
  AND TCOM.ID_GRUPO = TT.ID_GRUPO
  AND TCOM.NUMERO_TARIFARIO = TT.NUMERO_TARIFARIO
  WHERE (UPPER(TT.ID_TRANSPORTADOR) = UPPER(p_Transportador))
  AND (TT.ID_EMPRESA = p_IdEmpresa)
  AND (TT.ID_GRUPO = p_IdGrupo)
  AND (UPPER(TT.ESTADO) = 'VIG')
  AND (TRUNC(SYSDATE) BETWEEN TRUNC(TT.FECHA_INICIO_VIGENCIA) AND TRUNC(TT.FECHA_FIN_VIGENCIA))
  AND (UPPER(TCOM.DESCRIPCION_REGULACION) LIKE UPPER('%DEFECTO%'));

EXCEPTION
    WHEN NO_DATA_FOUND THEN
      DBMS_OUTPUT.PUT_LINE('EXCEPTION: NO_DATA_FOUND');

END GDS_OBTENER_COMISION_X_DEFECTO;

END PKG_GDS_MODULO_COMISION_PTA;
